#!@PERL_PROGRAM@
#
# Copyright (c) 2013  University of Texas at Austin. All rights reserved.
#
# $COPYRIGHT$
#
# Additional copyrights may follow
#
# This file is part of PerfExpert.
#
# PerfExpert is free software: you can redistribute it and/or modify it under
# the terms of the GNU Lesser General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your option) any
# later version.
#
# PerfExpert is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
# details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with PerfExpert. If not, see <http://www.gnu.org/licenses/>.
#
# Author: Leonardo Fialho
#
# $HEADER$
#

# Dedicated to Ashay, who loves Perl. 

if ("" eq $ARGV[0]) {
    printf("Usage: perfexpert_get_info.pl <program> [output]\n");
    exit -1;
}

@temp = `readelf -wi -W $ARGV[0] | grep DW_AT_producer`;
chomp($temp[0]);
($none, $none, $none, $producer) = split(": ", $temp[0], 4);

if ($producer =~ m/GNU C /) {
    $producer_code = "gcc";
}
if ($producer =~ m/GNU C\+\+/) {
    $producer_code = "g++";
}
if ($producer =~ m/GNU F/) {
    $producer_code = "gfortran";
}
if ($producer =~ m/Intel\(R\) C /) {
    $producer_code = "icc";
}
if ($producer =~ m/Intel\(R\) Fortran/) {
    $producer_code = "ifort";
}

@temp = `readelf -wi -W $ARGV[0] | grep DW_AT_language`;
chomp($temp[0]);
($none, $temp1) = split(":", $temp[0], 2);
($language_code, $none) = split(" ", $temp1, 2);

if ("1" eq $language_code) {
    $language = "C89";
}
if ("2" eq $language_code) {
    $language = "C";
}
if ("4" eq $language_code) {
    $language = "C++";
}
if ("7" eq $language_code) {
    $language = "F77";
}
if ("8" eq $language_code) {
    $language = "F90";
}
if ("12" eq $language_code) {
    $language = "C99";
}
if ("14" eq $language_code) {
    $language = "F95";
}

if ("" eq $ARGV[1]) {
    printf("producer_name=$producer\n");
    printf("producer_code=$producer_code\n");
    printf("language_name=$language\n");
    printf("language_code=$language_code\n");
} else {
    `echo "producer_name=$producer" > $ARGV[1]`;
    `echo "producer_code=$producer_code" >> $ARGV[1]`;
    `echo "language_name=$language" >> $ARGV[1]`;
    `echo "language_name=$language" >> $ARGV[1]`;
}

exit 0;

# EOF

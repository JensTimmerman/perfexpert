
# BEGIN OF PARSING/CHECKING ARGUMENTS
#
#         12345678901234567890123456789012345678901234567890123456789012345678901234567890
showHelp() {
    echo "Usage: perfexpert_run_exp [-ngh] [-t DIR] [-s FILE] [-o FILE] program_executable"
    echo "                          [program_arguments]"
    echo
    echo "  -s --structure FILE  Use FILE as program structure (generated by hpcstruct)"
    echo "  -o --output FILE     Save measurements to FILE"
    echo "  -n --no-debug        Do not switch to debug mode if program fails to execute"
    echo "                       with PerfExpert"
    echo "  -g --left-garbage    Do not remove the temporary directory"
    echo "  -t --tempdir DIR     Use DIR as temporary directory. The content in this"
    echo "                       directory will be erased before using it (!! WARNING !!)"
    echo "  -h --help            Show this message"
}

for arg; do
    delim=""
    case "$arg" in
        # translate GNU long options to short options
        --structure)    args="${args}-s ";;
        --output)       args="${args}-o ";;
        --no-debug)     args="${args}-n ";;
        --help)         args="${args}-h ";;
        --left-garbage) args="${args}-g ";;
        --tempdir)      argd="${args}-t ";;

        # pass through anything else
        *) [[ "${arg:0:1}" == "-" ]] || delim="\""
        args="${args}${delim}${arg}${delim} ";;
    esac
done

# Reset the positional parameters to the short options
eval set -- $args

debug=true
structure=""
structureSet=false
left_garbage=false
tempdir=false

# Generate output filename
if [ "x${JOB_NAME}" == "x" ]; then
    output_filename="experiment.xml"
else
    output_filename="experiment-${JOB_NAME}.o${JOB_ID}.xml"
fi

while getopts ":s:o:t:nhg" option 2>/dev/null; do
    case $option in
        s)
        structure="${OPTARG[@]}"
        structureSet=true
        ;;

        o)
        output_filename="${OPTARG[@]}"
        ;;

        n)
        debug=false
        ;;

        g)
        left_garbage=true
        ;;

        t)
        tempdir="${OPTARG[@]}"
        ;;

        h)
        showHelp
        exit 1
        ;;

        *)
        echo "Error: unrecognized option: ${OPTARG}"
        exit 1
        ;;
    esac
done
shift $(($OPTIND - 1))

command=${*}

# Sanity checks
if [ ${#} -lt 1 ]; then
    showHelp
    exit 1
fi

if [ "${structureSet}" == "true" ]; then
    hpcstruct_file=${structure}
    if [ ! -f ${hpcstruct_file} ]; then
        echo "Error: could not find hpcstruct file: ${hpcstruct_file}"
        exit 1
    fi
    echo "[perfexpert] Using existing structure file: ${hpcstruct_file}"
fi

program_name=${1}

arguments=""
shift
if [ "x${*}" != "x" ]; then
    arguments=${*}
fi

# If it is in ${PATH}, form the absolute path
fullPath=`which ${program_name} 2>/dev/null`
if [ ${?} -ne 0 ]; then
    # Try checking if the file is in the current directory
    if [ -x ./${program_name} ]; then
        fullPath=./${program_name}
    else
        # Instead of raising an error, use the program name as it is
        fullPath=${program_name}
    fi
fi

# Set the original variable back
program_name=${fullPath}

if [ ! -f ${program_name} ]; then
    echo "Error: could not run file: ${program_name}"
    exit 1
fi
#
# END OF PARSING/CHECKING ARGUMENTS

# Put everything into a temporary directory
if [ "${tmpdir}" == "false" ]; then
    tempdir=`mktemp -d .perfexpert-temp-XXXXXXX`
else
    mkdir -p "${tempdir}"
fi

# If for some reason tempdir was not set, set it to a default
if [ "x${tempdir}" == "x" ]; then
        tempdir=".perfexpert-temp"
        mkdir -p "${tempdir}"
fi

# Just to be sure, we remove any files which might previously exist
if [ "$tempdir" == "." ]; then
    echo "[perfexpert] Sorry, we can't use the current directory to store temporary files."
fi

if [ "$tempdir" == "./" ]; then
    echo "[perfexpert] Sorry, we can't use the current directory to store temporary files."
fi

# I don't like the idea of erasing with 'rm -rf *', let's try do something different
#rm -rf ${tempdir}/*
rm -rf ${tempdir}/hpcstruct
rm -rf ${tempdir}/measurements
rm -rf ${tempdir}/database
rm -rf ${tempdir}/hpcprof.message

# HPCTOOLKIT: STRUCT FILE (HPCSTRUCT)
#
# Check if we received the HPCStruct file as a parameter
if [ "x${hpcstruct_file}" != "x" ]; then
    # If yes, use it
    cp ${hpcstruct_file} ${tempdir}/hpcstruct
else
    # Else generate it
    echo -n "[perfexpert] Generating program structure using hpcstruct..."
    @HPCSTRUCT_PROGRAM@ --output ${tempdir}/hpcstruct ${program_name}
    echo " done!"
fi

# If anything goes bad, here is where we dump the information
debug_file="perfexpert_debug.out"

# HPCTOOLKIT: MEASURING PHASE (HPCRUN)
#
# Run experiments with different configurations
for index in $(seq 0 $((${#experiment[@]}-1))); do
    echo "[perfexpert] Program execution #$((${index}+1)) of ${#experiment[@]}"
    cmd="@HPCRUN_PROGRAM@ ${experiment[${index}]} --output ${tempdir}/measurements ${program_name} ${arguments}"
    eval ${cmd}

    if [ ${debug} == "true" -a ${?} != "0" ]; then
        echo "[perfexpert] Looks like the previous command failed to terminate cleanly, switching to debug mode..."

        rm -f ${debug_file}

        echo "[perfexpert] Collecting information about OS and processor..."

        uname -a >> ${debug_file} 2>&1
        echo >> ${debug_file}
        cat /proc/cpuinfo >> ${debug_file} 2>&1

        echo -e "Command: ${cmd}\n" >> ${debug_file}
        echo -e "run\nbt\nthread apply all bt\nquit" > ${tempdir}/stacktraces.cmd

        echo "[perfexpert] Collecting stack trace..."
        dbg_cmd="gdb --command=${tempdir}/stacktraces.cmd --args /bin/sh ${cmd} 2>> ${debug_file} 1>/dev/null"
        eval ${dbg_cmd}

        echo "[perfexpert] Collecting debug information from hpcrun monitor..."
        dbg_cmd="@HPCRUN_PROGRAM@ --monitor-debug ${experiment[${index}]} --output ${tempdir}/measurements ${program_name} ${arguments} 2>> ${debug_file} 1>/dev/null"
        echo -e "\nCommand: ${dbg_cmd}\n" >> ${debug_file}
        eval ${dbg_cmd}

        echo "[perfexpert] Debug information collected in ./${debug_file}, please send this file to the PerfExpert group for review. Thanks!"

        # Clean up
        rm -rf core
        if [ "${left_garbage}" == "false" ]; then
            rm -rf ${tempdir}
        else
            echo "[perfexpert] Temporary files are available on '${tempdir}' directory"
        fi
        exit 1
    fi
done

# HPCTOOLKIT: SUMMARIZING RESULTS (HPCPROF)
#
echo -n "[perfexpert] Finished all measurements, summarizing the results..."
@HPCPROF_PROGRAM@ --force-metric --metric=thread --struct ${tempdir}/hpcstruct --output ${tempdir}/database ${tempdir}/measurements &> ${tempdir}/hpcprof.message
returnCode=${?}

if [ "x${returnCode}" != "x0" ]; then
    echo "error!"
    cat ${tempdir}/hpcprof.message

    # Clean up
    if [ "${left_garbage}" == "false" ]; then
        rm -rf ${tempdir}
    else
        echo "[perfexpert] Temporary files are available on '${tempdir}' directory"
    fi
else
    echo " done!"

    # Get the final experiment.xml here
    cp ${tempdir}/database/experiment.xml ./${output_filename}

    # Clean up
    if [ "${left_garbage}" == "false" ]; then
        rm -rf ${tempdir}
    else
        echo "[perfexpert] Temporary files are available on '${tempdir}' directory"
    fi

    echo "[perfexpert] Run the following command to analyze the measurement data:"
    echo "[perfexpert] perfexpert <threshold-between-0-and-1> ./${output_filename}"
fi

#!@PERL_PROGRAM@
#
# Copyright (c) 2011-2013  University of Texas at Austin. All rights reserved.
#
# $COPYRIGHT$
#
# Additional copyrights may follow
#
# This file is part of PerfExpert.
#
# PerfExpert is free software: you can redistribute it and/or modify it under
# the terms of the The University of Texas at Austin Research License
# 
# PerfExpert is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE.
# 
# Authors: Leonardo Fialho and Ashay Rane
#
# $HEADER$
#
# Dedicated to Ashay, who loves Perl. 

# Check for arguments
if ("" eq $ARGV[0]) {
    printf("Usage: perfexpert_get_compiler_info.pl <program> [output]\n");
    exit -1;
}

# Check if files exists
unless (-e $ARGV[0]) {
    print "File not found!";
    exit -1;
}

# Default values
$producer = "unknown";
$producer_code = "unknown";
$language = "unknown";
$language_code = "unknown";

# Read information
@temp = `readelf -wi -W $ARGV[0] | grep DW_AT_producer`;
chomp($temp[0]);
($none, $none, $none, $producer) = split(": ", $temp[0], 4);

if ($producer =~ m/GNU C /) {
    $producer_code = "gcc";
}
if ($producer =~ m/GNU C\+\+/) {
    $producer_code = "g++";
}
if ($producer =~ m/GNU F/) {
    $producer_code = "gfortran";
}
if ($producer =~ m/Intel\(R\) C /) {
    $producer_code = "icc";
}
if ($producer =~ m/Intel\(R\) C\+\+/) {
    $producer_code = "icpc";
}
if ($producer =~ m/Intel\(R\) Fortran/) {
    $producer_code = "ifort";
}

@temp = `readelf -wi -W $ARGV[0] | grep DW_AT_language`;
chomp($temp[0]);
($none, $temp1) = split(":", $temp[0], 2);
($language_code, $none) = split(" ", $temp1, 2);

if ("1" eq $language_code) {
    $language = "C89";
}
if ("2" eq $language_code) {
    $language = "C";
}
if ("4" eq $language_code) {
    $language = "C++";
}
if ("7" eq $language_code) {
    $language = "F77";
}
if ("8" eq $language_code) {
    $language = "F90";
}
if ("12" eq $language_code) {
    $language = "C99";
}
if ("14" eq $language_code) {
    $language = "F95";
}

# Print information
if ("" eq $ARGV[1]) {
    printf("producer_name=$producer\n");
    printf("producer_code=$producer_code\n");
    printf("language_name=$language\n");
    printf("language_code=$language_code\n");
} else {
    `echo "producer_name=$producer" > $ARGV[1]`;
    `echo "producer_code=$producer_code" >> $ARGV[1]`;
    `echo "language_name=$language" >> $ARGV[1]`;
    `echo "language_name=$language" >> $ARGV[1]`;
}

exit 0;

# EOF

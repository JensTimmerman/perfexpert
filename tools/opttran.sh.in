#!@BASH_PROGRAM@
#
# Copyright (c) 2013  University of Texas at Austin. All rights reserved.
#
# $COPYRIGHT$
#
# Additional copyrights may follow
#
# This file is part of OptTran.
#
# OptTran as well PerfExpert are free software: you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public License as
# published by the Free Software Foundation, either version 3 of the License,
# or (at your option) any later version.
#
# OptTran and PerfExpert are distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser
# General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with OptTran or PerfExpert. If not, see <http://www.gnu.org/licenses/>.
#
# Author: Leonardo Fialho
#
# $HEADER$
#

# TODO:
#
# 1) Receive compiler/compilation flags as parameters
# 2) Create the unique identifier for opttran run
# 3) Insert such identifier on tools arguments
# 4) ...

###############################################################################
#         12345678901234567890123456789012345678901234567890123456789012345678901234567890
showHelp() {
    echo "Usage: opttran [-ghvq] [-w DIR] [-s FILE] program_executable [program_arguments]"
    echo
    echo "  -s --source FILE    Use FILE as the source code"
    echo "  -q --quiet          Disable verbose mode"
    echo "  -v --verbose        Enable verbose mode"
    echo "  -w --workdir DIR    Use DIR as temporary directory"
    echo "  -g --left-garbage   Do not remove the temporary directory"
    echo "  -h --help           Show this message"
}

###############################################################################
perfexpert_run_exp() {
#
# Set 'perfexpert_run_exp' up
#
OPTTRAN_PERFEXPERT_RUN_EXP_CMD="${OPTTRAN_PERFEXPERT_RUN_EXP}"
OPTTRAN_PERFEXPERT_RUN_EXP_CMD+=" -t ${OPTTRAN_DIR}"
OPTTRAN_PERFEXPERT_RUN_EXP_CMD+=" -g"
OPTTRAN_PERFEXPERT_RUN_EXP_CMD+=" -o ${OPTTRAN_DIR}/perfexpert-experiment.xml"
OPTTRAN_PERFEXPERT_RUN_EXP_CMD+=" ${USER_BINARY}"
OPTTRAN_PERFEXPERT_RUN_EXP_CMD+=" &> ${OPTTRAN_DIR}/perfexpert_run_exp.output.txt"
#
# Run PerfExpert (run_exp)
echo -n "[opttran.sh] Step 1 of 7: Running PerfExpert measurements phase (this could take a while)..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_PERFEXPERT_RUN_EXP_CMD}" >> ${LOGFILE}
fi
eval ${OPTTRAN_PERFEXPERT_RUN_EXP_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running PerfExpert (run_exp)" >> ${LOGFILE}
    echo "[opttran.sh] Error: running PerfExpert (run_exp)"
    exit 1
fi
}

###############################################################################
perfexpert() {
#
# Set 'perfexpert' up
#
OPTTRAN_PERFEXPERT_CMD="${OPTTRAN_PERFEXPERT}"
OPTTRAN_PERFEXPERT_CMD+=" --recommend"
OPTTRAN_PERFEXPERT_CMD+=" --opttran"
OPTTRAN_PERFEXPERT_CMD+=" 0.1"
OPTTRAN_PERFEXPERT_CMD+=" ${OPTTRAN_DIR}/perfexpert-experiment.xml"
OPTTRAN_PERFEXPERT_CMD+=" &> ${OPTTRAN_DIR}/perfexpert.output.txt"
#
OPTTRAN_PERFEXPERT_CMD2="${OPTTRAN_PERFEXPERT}"
OPTTRAN_PERFEXPERT_CMD2+=" 0.1"
OPTTRAN_PERFEXPERT_CMD2+=" ${OPTTRAN_DIR}/perfexpert-experiment.xml"
OPTTRAN_PERFEXPERT_CMD2+=" &> ${OPTTRAN_DIR}/perfexpert_analysis.output.txt"
#
# Run PerfExpert (analysis)
echo -n "[opttran.sh] Step 2 of 7: Running PerfExpert analysis phase..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_PERFEXPERT_CMD2}" >> ${LOGFILE}
fi
eval ${OPTTRAN_PERFEXPERT_CMD2}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running PerfExpert (analysis)" >> ${LOGFILE}
    echo "[opttran.sh] Error: running PerfExpert (analysis)"
    exit 1
fi

# Run PerfExpert (recommend)
echo -n "[opttran.sh] Step 3 of 7: Running PerfExpert recommend phase..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_PERFEXPERT_CMD}" >> ${LOGFILE}
fi
eval ${OPTTRAN_PERFEXPERT_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running PerfExpert (recommend)" >> ${LOGFILE}
    echo "[opttran.sh] Error: running PerfExpert (recommend)"
    exit 1
fi

# Clean PerfExpert perfexpert.log
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Moving: perfexpert.log to ${OPTTRAN_DIR}/" >> ${LOGFILE}
fi
eval mv perfexpert.log ${OPTTRAN_DIR}/
if [ 0 != $? ]; then
    echo "[opttran.sh] Error: unable to move perfexpert.log" >> ${LOGFILE}
fi
}

###############################################################################
recommender() {
# Set 'recommender' up
#
OPTTRAN_RECOMMENDER_CMD="${OPTTRAN_RECOMMENDER}"
OPTTRAN_RECOMMENDER_CMD+=" --verbose_level 10"
OPTTRAN_RECOMMENDER_CMD+=" --inputfile ${OPTTRAN_DIR}/perfexpert.output.txt"
OPTTRAN_RECOMMENDER_CMD+=" --colorful"
OPTTRAN_RECOMMENDER_CMD+=" --opttran ${OPTTRAN_DIR}"
OPTTRAN_RECOMMENDER_CMD+=" --sourcefile ${USER_SOURCE}"
OPTTRAN_RECOMMENDER_CMD+=" &> ${OPTTRAN_DIR}/recommender.output.txt"
#
# Run Recommender
echo -n "[opttran.sh] Step 4 of 7: Looking for recommendations..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_RECOMMENDER_CMD}" >> ${LOGFILE}
fi
eval ${OPTTRAN_RECOMMENDER_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running Recommender" >> ${LOGFILE}
    echo "[opttran.sh] Error: running Recommender"
    exit 1
fi
}

###############################################################################
opttran_pr() {
#
# Set 'opttran_pr' up
#
OPTTRAN_PR_CMD="${OPTTRAN_PR}"
OPTTRAN_PR_CMD+=" --verbose_level 10"
OPTTRAN_PR_CMD+=" --colorful"
OPTTRAN_PR_CMD+=" --inputfile ${OPTTRAN_DIR}/opttran_recommendations.txt"
OPTTRAN_PR_CMD+=" --testall"
OPTTRAN_PR_CMD+=" --opttran ${OPTTRAN_DIR}"
OPTTRAN_PR_CMD+=" &> ${OPTTRAN_DIR}/opttran_pr.output.txt"
#
# Run the Pattern Recognizer
echo -n "[opttran.sh] Step 5 of 7: Testing feasibility of recommendations..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_PR_CMD}" >> ${LOGFILE}
fi
eval ${OPTTRAN_PR_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running OptTran:PR, calling recommender" >> ${LOGFILE}
    echo "[opttran.sh] Sorry, we ran out of automatic transformations."
    echo "[opttran.sh] Here are some optimizations we recommend:"
    ${OPTTRAN_RECOMMENDER} --inputfile ${OPTTRAN_DIR}/perfexpert.output.txt
    exit 1
fi
}

###############################################################################
opttran_ct() {
#
# Set 'opttran_ct' up
#
OPTTRAN_CT_CMD="${OPTTRAN_CT}"
OPTTRAN_CT_CMD+=" --verbose_level 10"
OPTTRAN_CT_CMD+=" --colorful"
OPTTRAN_CT_CMD+=" --inputfile ${OPTTRAN_DIR}/opttran_transformations.txt"
OPTTRAN_CT_CMD+=" --opttran ${OPTTRAN_DIR}"
OPTTRAN_CT_CMD+=" &> ${OPTTRAN_DIR}/opttran_ct.output.txt"
#
# Run the Code Transformer
echo -n "[opttran.sh] Step 6 of 7: Applying code transformations..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_CT_CMD}" >> ${LOGFILE}
fi
eval ${OPTTRAN_CT_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running OptTran:CT" >> ${LOGFILE}
    echo "[opttran.sh] Error: running OptTran:CT"
    exit 1
fi
}

###############################################################################
opttran_ci() {
# Set 'opttran_ci' up
#
OPTTRAN_CI_CMD="${OPTTRAN_CI}"
OPTTRAN_CI_CMD+=" --verbose_level 10"
OPTTRAN_CI_CMD+=" --colorful"
OPTTRAN_CI_CMD+=" --inputfile ${OPTTRAN_DIR}/opttran_functions.txt"
OPTTRAN_CI_CMD+=" --opttran ${OPTTRAN_DIR}"
OPTTRAN_CI_CMD+=" --outputdir ${OPTTRAN_CI_OUTPUT_DIR}"
OPTTRAN_CI_CMD+=" &> ${OPTTRAN_DIR}/opttran_ci.output.txt"
#
# Run the Code Integrator
echo -n "[opttran.sh] Step 7 of 7: Integrating application source code..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${OPTTRAN_CI_CMD}" >> ${LOGFILE}
fi
eval ${OPTTRAN_CI_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: running OptTran:CI" >> ${LOGFILE}
    echo "[opttran.sh] Error: running OptTran:CI"
    exit 1
fi
}

###############################################################################
compile() {
#
COMPILE_CMD="gcc -g -O3 -o ${USER_BINARY} ${USER_SOURCE}"
#
echo -n "[opttran.sh] Compiling..." >> ${VERBOSE}
if [ x"${DEBUG}" == x"yes" ]; then
    echo "[opttran.sh] Running: ${COMPILE_CMD}" >> ${LOGFILE}
fi
eval ${COMPILE_CMD}
if [ 0 == $? ]; then
    echo " ok!" >> ${VERBOSE}
else
    echo " fail :(" >> ${VERBOSE}
    echo "[opttran.sh] Error: compiling code" >> ${LOGFILE}
    echo "[opttran.sh] Error: compiling code"
    exit 1
fi
}

###############################################################################
# Parsing options
#
for arg; do
    delim=""
    case "$arg" in
        # translate GNU long options to short options
        --source)       args="${args}-s ";;
        --quiet)        args="${args}-q ";;
        --verbose)      args="${args}-v ";;
        --help)         args="${args}-h ";;
        --left-garbage) args="${args}-g ";;
        --workdir)      args="${args}-w ";;

        # pass through anything else
        *) [[ "${arg:0:1}" == "-" ]] || delim="\""
        args="${args}${delim}${arg}${delim} ";;
    esac
done

# Reset the positional parameters to the short options
eval set -- $args

# Default values
DEBUG="yes"

while getopts ":s:w:hgqv" option 2>/dev/null; do
    case $option in
        s)
        USER_SOURCE="${OPTARG[@]}"
        ;;

        w)
        OPTTRAN_DIR="${OPTARG[@]}"
        ;;

        q)
        DEBUG="no"
        ;;

        v)
        DEBUG="yes"
        ;;

        h)
        showHelp
        exit 1
        ;;

        *)
        echo "[opttran] Error: unrecognized option: ${OPTARG}"
        exit 1
        ;;
    esac
done
shift $(($OPTIND - 1))

USER_BINARY=${*}

VERBOSE="/dev/stdout"
LOGFILE="${OPTTRAN_DIR}/opttran.log"

# Sanity checks
if [ ${#} -lt 1 ]; then
    showHelp
    exit 1
fi

###############################################################################
# Script variables
#
# Install directories
#
OPTTRAN_PREFIX="@prefix@"
OPTTRAN_BINDIR="@prefix@/bin"
OPTTRAN_LIBDIR="@prefix@/lib"
OPTTRAN_ETCDIR="@prefix@/etc"
OPTTRAN_VARDIR="@prefix@/var"
#
# Path to tools
#
OPTTRAN_PERFEXPERT_RUN_EXP="${OPTTRAN_BINDIR}/perfexpert_run_exp"
OPTTRAN_PERFEXPERT="${OPTTRAN_BINDIR}/perfexpert"
OPTTRAN_RECOMMENDER="${OPTTRAN_BINDIR}/recommender"
OPTTRAN_PR="${OPTTRAN_BINDIR}/opttran_pr"
OPTTRAN_CT="${OPTTRAN_BINDIR}/opttran_ct"
OPTTRAN_CI="${OPTTRAN_BINDIR}/opttran_ci"

ROUND=0
ORIGINAL_OPTTRAN_DIR=${OPTTRAN_DIR}

while [ 1 ]; do
    # Which round is this? Update variables!
    ROUND=$(($ROUND + 1))
    OPTTRAN_DIR="${ORIGINAL_OPTTRAN_DIR}/${ROUND}"
    OPTTRAN_CI_OUTPUT_DIR="${OPTTRAN_DIR}/fragments/new"

    # Create OPTTRAN dir
    eval @MKDIR_P@ ${OPTTRAN_DIR}
    if [ 0 != $? ]; then
        echo "[opttran.sh] Error: unable to create OPTTRAN directory (${OPTTRAN_DIR})"
        exit 1
    fi
    if [ x"${DEBUG}" == x"yes" ]; then
        echo "[opttran.sh] Creating dir: ${OPTTRAN_DIR}" >> ${LOGFILE}
        echo "[opttran.sh] @MKDIR_P@ ${OPTTRAN_DIR}" >> ${LOGFILE}
    fi

    if [ x"${DEBUG}" == x"yes" ]; then
        echo "[opttran.sh] DEBUG=${DEBUG}" >> ${LOGFILE}
        echo "[opttran.sh] USER_SOURCE=${USER_SOURCE}" >> ${LOGFILE}
        echo "[opttran.sh] USER_BINARY=${USER_BINARY}" >> ${LOGFILE}
        echo "[opttran.sh] OPTTRAN_DIR=${OPTTRAN_DIR}" >> ${LOGFILE}
        echo "[opttran.sh] LOGFILE=${OPTTRAN_DIR}/opttran.log" >> ${LOGFILE}
        echo "[opttran.sh] OPTTRAN_CI_OUTPUT_DIR=${OPTTRAN_CI_OUTPUT_DIR}" >> ${LOGFILE}
        echo "[opttran.sh]" >> ${LOGFILE}
    fi

    # Run the tools
    compile
    perfexpert_run_exp
    perfexpert
    recommender
    opttran_pr
    opttran_ct
    opttran_ci

    echo "[opttran.sh] The new source code is in: ${OPTTRAN_CI_OUTPUT_DIR}"

    mv ${OPTTRAN_CI_OUTPUT_DIR}/${USER_SOURCE}.new ${OPTTRAN_CI_OUTPUT_DIR}/${USER_SOURCE}
    USER_SOURCE="${OPTTRAN_CI_OUTPUT_DIR}/${USER_SOURCE}"
done

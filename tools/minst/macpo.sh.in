#!@BASH_PROGRAM@
#
# $HEADER$
#

prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=@bindir@
INCDIR=@includedir@
LIBDIR=@libdir@
ABS_BUILDDIR=@abs_builddir@

# Try to find the minst executable
if [ -f ${BINDIR}/minst ]; then
    # Probable location after install
    MINST_PATH="${BINDIR}/minst"
elif [ -f ${ABS_BUILDDIR}/minst ]; then
    # Probable location before install
    MINST_PATH="${ABS_BUILDDIR}/minst"
else
    echo "Unable to find the minst executable"
    exit 1
fi

# Try to find the path to the mrt.h header file
if [ -f ${INCDIR}/mrt.h ]; then
    # Probable location after install
    MRT_INCLUDE_DIR="${INCDIR}"
elif [ -f ${ABS_BUILDDIR}/libmrt/mrt.h ]; then
    # Probable location before install
    MRT_INCLUDE_DIR="${ABS_BUILDDIR}/libmrt"
else
    echo "Unable to find the mrt.h header file"
    exit 1
fi

# Try to find the path to libmrt
if [ -f ${LIBDIR}/libmrt.a ]; then
    # Probable location after install
    MRT_LIB_DIR="${LIBDIR}"
elif [ -f ${ABS_BUILDDIR}/libmrt/libmrt.a ]; then
    # Probable location before install
    MRT_LIB_DIR="${ABS_BUILDDIR}/libmrt"
else
    echo "Unable to find libmrt"
    exit 1
fi

mktemp=`which mktemp`
if [ -n "$mktemp" ]
then
	tmp_minst=`mktemp --tmpdir -t macpo.XXXXX`
	tmp_gfort=`mktemp --tmpdir -t macpo.XXXXX`
else
	tmp_minst=/tmp/macpo.minst
	tmp_gfort=/tmp/macpo.gfort
fi

# Finally, invoke the minst executable
${MINST_PATH} -I${MRT_INCLUDE_DIR} -L${MRT_LIB_DIR} $* -lmrt &> "$tmp_minst"

if [ $? != 0 ]
then
	# try running with gfortran
	if [ -z "${GNU_FORTRAN_COMPILER}" ]
	then
		GNU_FORTRAN_COMPILER=`which gfortran`
	fi

	if [ -n "$GNU_FORTRAN_COMPILER" -a -f "$GNU_FORTRAN_COMPILER" ]
	then
		"$GNU_FORTRAN_COMPILER" -L${MRT_LIB_DIR} $* -lmrt &> "$tmp_gfort"

		# If this also resulted in an error, show the original minst error
		if [ $? != 0 ]
		then
			cat "$tmp_minst"
		else
			cat "$tmp_gfort"
		fi
	else
		cat "$tmp_minst"
	fi
else
	cat "$tmp_minst"
fi

# Clean up
rm -f "$tmp_minst" "$tmp_gfort" 2>/dev/null
